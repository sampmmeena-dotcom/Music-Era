<!DOCTYPE html>
<html>
<head>
  <title>My Music Era</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    h1 { color: #333; }
    ul { list-style: none; padding: 0; }
    li { margin: 10px 0; background: #fff; padding: 10px; border-radius: 5px; }
    button { margin-left: 5px; }
    #player { width: 100%; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Welcome <span id="user-email"></span></h1>

  <h2>Your Playlist:</h2>
  <div id="playlist-container"></div>

  <h3>Upload a New Song</h3>
  <form id="upload-form" enctype="multipart/form-data">
    <input type="file" name="song" accept=".mp3" required>
    <button type="submit">Upload</button>
  </form>

  <audio id="player" controls>
    <source id="player-source" src="" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>

  <div style="margin-top: 10px;">
    <button onclick="toggleShuffle()">ğŸ”€ Shuffle</button>
    <button onclick="toggleRepeat()">ğŸ” Repeat</button>
  </div>

  <script>
    const token = localStorage.getItem('token');
    let currentPlaylist = [];
    let currentIndex = 0;
    let isShuffle = false;
    let isRepeat = false;

    fetch('/api/profile', {
      headers: { 'Authorization': 'Bearer ' + token }
    }).then(res => res.json())
      .then(data => {
        document.getElementById('user-email').textContent = data.email;
      });

    fetch('/api/playlists', {
      headers: { 'Authorization': 'Bearer ' + token }
    }).then(res => res.json())
      .then(data => {
        const container = document.getElementById('playlist-container');
        container.innerHTML = '';

        Object.entries(data).forEach(([name, playlist]) => {
          const list = playlist.songs.map(song => `
            <li>
              ${song}
              <button onclick="playSong('${song}', ${JSON.stringify(playlist.songs)})">â–¶ï¸ Play</button>
              <button onclick="promptAddToPlaylist('${song}')">â• Add</button>
              <button onclick="removeFromPlaylist('${name}', '${song}')">ğŸ—‘ï¸ Remove</button>
              <button onclick="toggleFavorite('${song}')">â¤ï¸ Favorite</button>
            </li>
          `).join('');

          container.innerHTML += `<h3>${name}</h3><ul>${list}</ul>`;
        });
      });

    function playSong(song, playlist = []) {
      const player = document.getElementById('player');
      const source = document.getElementById('player-source');
      currentPlaylist = playlist;
      currentIndex = playlist.indexOf(song);
      source.src = `/songs/${song}`;
      player.load();
      player.play();
    }

    function toggleShuffle() {
      isShuffle = !isShuffle;
      alert(`Shuffle is now ${isShuffle ? 'ON' : 'OFF'}`);
    }

    function toggleRepeat() {
      isRepeat = !isRepeat;
      alert(`Repeat is now ${isRepeat ? 'ON' : 'OFF'}`);
    }

    document.getElementById('player').addEventListener('ended', () => {
      if (isRepeat) {
        playSong(currentPlaylist[currentIndex], currentPlaylist);
      } else {
        currentIndex = isShuffle
          ? Math.floor(Math.random() * currentPlaylist.length)
          : (currentIndex + 1) % currentPlaylist.length;
        playSong(currentPlaylist[currentIndex], currentPlaylist);
      }
    });

    function toggleFavorite(song) {
      fetch('/api/favorites', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ song })
      }).then(res => res.json())
        .then(data => {
          if (data.success) alert(`Toggled favorite: ${song}`);
        });
    }

    function promptAddToPlaylist(song) {
      const name = prompt('Add to which playlist?');
      if (!name) return;
      fetch('/api/add-to-playlist', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ name, song })
      }).then(() => location.reload());
    }

    function removeFromPlaylist(name, song) {
      fetch('/api/remove-from-playlist', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify({ name, song })
      }).then(() => location.reload());
    }

    document.getElementById('upload-form').addEventListener('submit', e => {
      e.preventDefault();
      const formData = new FormData(e.target);
      fetch('/api/upload', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token },
        body: formData
      }).then(() => location.reload());
    });
  </script>
</body>
</html>